##Module description

This module implements a torque control balancing strategy.
It computes the joint torques and interaction forces at the feet in order to stabilize the following desired dynamics:
    - center of mass (CoM) position
    - root link orientation
    - left foot frame position + orientation
    - right foot frame position + orientation
A cost function penalizing high error on desired joint positions is added to the control framework.

For details see [An Optimization Based Control Framework for Balancing and Walking: Implementation on the iCub Robot](online link to come)

###Compatibility
The repository contains three Simulink models: 
	`torqueBalancing.mdl`, which is generated by using Matlab R2016b,
	`torqueBalancing2015b86.mdl`, which is exported from the first model to be compatible with Matlab R2015b->now
	`torqueBalancing2012b.mdl`, which is exported from the first model to be compatible with Matlab R2012b->now.
Also, the controller is tested in simulation by using Gazebo 7.0. Older versions of Gazebo may lead to scarse, or unstable, control performances.

###Launch procedure
The procedure to run the torque balancing module is still quite elaborate.
Users willing to use the module should follow this list.

- Set the environmental variable YARP_ROBOT_NAME in the bashrc according to the robot one wants to use (e.g. icubGazeboSim for simulations, or iCubGenova01, iCubParis01, etc. for experiments).
- (Simulation only) Launch yarpserver.
- (Simulation only) Launch gazebo. If you want to use the synchronization between the controller and the simulator to avoid real-time factor related problems, launch gazebo as follows: `gazebo -slibgazebo_yarp_clock.so`. Insert an iCub model.
- Bring the robot in a suitable home position (e.g. `$ yarpmotorgui --from homePoseBalancin.ini`, in the `Global Joints Command` menu, select `Custom Positions` then click on `Move all parts to NewController`)
-  Launch `wholeBodyDynamicsTree` as follows: `$ wholeBodyDynamicsTree`
- (Robot only) Execute the [sensors calibration script](https://github.com/robotology/codyco-modules/blob/master/src/scripts/twoFeetStandingIdleAndCalib.sh): `$ twoFeetStandingIdleAndCalib.sh`
- Open the simulink model `torqueBalancing.mdl` (or older version).
- Run the module.

##Module details
###Configuration file
At start, the module calls the initialization file initTorqueBalancing.m. Once open, this file contains some configuration variables.
####General section
- `YARP_ROBOT_NAME` : name of the robot to connect to, i.e. 'icubGazeboSim' for simulations, or 'CubGenova01' 'iCubParis01' etc. for experiments
- `WBT_modelName`: module name. Ports will be opened with this name. Default to `matlabTorqueBalancing`
- `simulationTime`: time of the simulation/experiment

####Gains
The gains for the robot specified by the variable `YARP_ROBOT_NAME` can be found in the folder `app/robots/YARP_ROBOT_NAME/`The files gains.m and initStateMachineWalking.m contain several gains, among which

- `sat.torque`: saturations to be applied to the output torques. It must be a positive value.
- `gain.CoM.posPD`: proportional and derivative gains for the CoM position
- `gain.root.rotPD`: proportional and derivative gains for the root orientation
- `gain.lFoot.posPD`: proportional and derivative gains for the left foot position
- `gain.lFoot.rotPD`: proportional and derivative gains for the left foot orientation
- `gain.rFoot.posPD`: proportional and derivative gains for the right foot position
- `gain.rFoot.rotPD`: proportional and derivative gains for the right foot orientation
- `gain.joints. impedances`: gains for the impedance (low level) task. The number must match the number of torque controlled joints.

#### CoM, root and feet reference
It is possible to send a `CoM` reference by connecting to the streaming port `comDes:i`. The port expects 9 elements: 3 values for the  desired CoM  position, 3 values for the  desired CoM velocity and 3 values for the  desired CoM acceleration.
Similarly for the root and feet.

#### Joint reference
It is possible to send the impedance resting position as a reference to the streaming port `qdes:i`. This port expects the same number of element as the torque controlled joints. References are in **radians**


#### Citing this contribution
In case you want to cite the content of this module please refer to [An Optimization Based Control Framework for Balancing and Walking: Implementation on the iCub Robot](online link to come) and use the following bibtex entry:

```
upcoming bibtex entry

```
